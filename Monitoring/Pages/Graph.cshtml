@page
@model GraphModel
@{
    ViewData["Title"] = "Graph";
}

<h2>Graph</h2>

<div>
    <canvas id="productionChart" width="400" height="200"></canvas>
</div>

<h3>Add Production Data</h3>

<form id="dataForm" method="post">
    <div>
        <label>Final Target:</label>
        <input type="number" asp-for="NewProduction.FinalTarget" />
    </div>
    <div>
        <label>Now Target:</label>
        <input type="number" asp-for="NewProduction.NowTarget" />
    </div>
    <div>
        <label>Result:</label>
        <input type="number" asp-for="NewProduction.Result" />
    </div>
    <button type="submit">Submit</button>
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        // Custom plugin to draw the current time line
        const currentTimeLinePlugin = {
            id: 'currentTimeLine',
            beforeDraw: (chart) => {
                const ctx = chart.ctx;
                const xScale = chart.scales['x'];
                const yScale = chart.scales['y'];
                const currentTime = new Date('@Model.CurrentTime');
                const currentPixel = xScale.getPixelForValue(currentTime);

                ctx.save();
                ctx.beginPath();
                ctx.moveTo(currentPixel, yScale.top);
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.lineTo(currentPixel, yScale.bottom);
                ctx.stroke();
                ctx.restore();
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            var shiftStart = new Date('@Model.ShiftStart');
            var shiftEnd = new Date('@Model.ShiftEnd');
            var currentTime = new Date('@Model.CurrentTime');

            var ctx = document.getElementById('productionChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.Labels)),
                    datasets: [
                        {
                            label: 'Final Target',
                            data: @Html.Raw(Json.Serialize(Model.FinalTargetData)),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Now Target',
                            data: @Html.Raw(Json.Serialize(Model.NowTargetData)),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Result',
                            data: @Html.Raw(Json.Serialize(Model.ResultData)),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'HH:mm',
                                displayFormats: {
                                    hour: 'HH:mm'
                                },
                                min: shiftStart,
                                max: shiftEnd
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Values'
                            }
                        }
                    },
                    plugins: {
                        currentTimeLine: true
                    }
                },
                plugins: [currentTimeLinePlugin]
            });

            document.getElementById('dataForm').addEventListener('submit', function (event) {
                event.preventDefault();

                var formData = new FormData(event.target);
                var jsonData = {
                    FinalTarget: formData.get('NewProduction.FinalTarget'),
                    NowTarget: formData.get('NewProduction.NowTarget'),
                    Result: formData.get('NewProduction.Result')
                };

                fetch('@Url.Page("Graph")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(jsonData)
                })
                    .then(response => response.json())
                    .then(data => {
                        chart.data.labels = data.labels;
                        chart.data.datasets[0].data = data.finalTargetData;
                        chart.data.datasets[1].data = data.nowTargetData;
                        chart.data.datasets[2].data = data.resultData;
                        chart.options.scales.x.min = new Date(data.shiftStart);
                        chart.options.scales.x.max = new Date(data.shiftEnd);
                        chart.options.plugins.currentTimeLine = true;
                        chart.update();
                    })
                    .catch(error => console.error('Error:', error));
            });
        });
    </script>
}
